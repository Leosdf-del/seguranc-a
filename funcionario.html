<script>
    // Configuração do Supabase
    const SUPABASE_URL = 'https://lmlxvmzeifjvjakpomgp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxtbHh2bXplaWZqdmpha3BvbWdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMwMTQ0MzgsImV4cCI6MjA1ODU5MDQzOH0.QmHSbZrzRhos0DqQFZDnbeqvV9dcRYISQ88MbNsRDyM';

    // Páginas
    const loginPage = document.getElementById('login-page');
    const mainPortal = document.getElementById('main-portal');
    const adminPortal = document.getElementById('admin-portal');
    const loginForm = document.getElementById('login-form');
    const loginError = document.getElementById('login-error');

    // Function to show/hide loading overlay
    function showLoading(show = true) {
        const loadingOverlay = document.getElementById('loadingOverlay') || createLoadingOverlay();
        loadingOverlay.style.display = show ? 'flex' : 'none';
    }

    // Create loading overlay if it doesn't exist
    function createLoadingOverlay() {
        const overlay = document.createElement('div');
        overlay.id = 'loadingOverlay';
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        `;
        
        const spinner = document.createElement('div');
        spinner.style.cssText = `
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        `;
        
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        
        document.head.appendChild(style);
        overlay.appendChild(spinner);
        document.body.appendChild(overlay);
        return overlay;
    }

    // Password visibility toggle
    const passwordInput = document.getElementById('password-input');
    const passwordToggle = document.createElement('span');
    passwordToggle.textContent = '👁️';
    passwordToggle.style.cssText = `
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        user-select: none;
    `;
    passwordInput.parentNode.style.position = 'relative';
    passwordInput.parentNode.appendChild(passwordToggle);

    passwordToggle.addEventListener('click', () => {
        const type = passwordInput.type === 'password' ? 'text' : 'password';
        passwordInput.type = type;
        passwordToggle.textContent = type === 'password' ? '👁️' : '👁️‍🗨️';
    });

    // Initialize Supabase
    let supabase;
    try {
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } catch (error) {
        console.error('Supabase initialization error:', error);
        loginError.textContent = 'Erro ao inicializar autenticação';
        loginError.classList.remove('hidden');
    }

    // Authentication
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email-input').value.trim();
        const password = document.getElementById('password-input').value;

        // Basic validation
        if (!email || !password) {
            loginError.textContent = 'Por favor, preencha todos os campos';
            loginError.classList.remove('hidden');
            return;
        }

        try {
            showLoading(true);
            loginError.classList.add('hidden');

            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            });

            if (error) {
                throw error;
            }

            if (data.user) {
                // Verify user role
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('role')
                    .eq('email', email)
                    .single();

                if (userError) throw userError;

                if (userData.role === 'admin') {
                    showAdminPortal();
                } else {
                    showMainPortal();
                }
            }
        } catch (error) {
            loginError.textContent = error.message || 'Credenciais inválidas. Tente novamente.';
            loginError.classList.remove('hidden');
            console.error('Login error:', error);
        } finally {
            showLoading(false);
        }
    });

    // Logout
    document.getElementById('logout-btn').addEventListener('click', logout);
    document.getElementById('admin-logout-btn').addEventListener('click', logout);

    async function logout() {
        try {
            showLoading(true);
            await supabase.auth.signOut();
            showLoginPage();
        } catch (error) {
            console.error('Logout error:', error);
        } finally {
            showLoading(false);
        }
    }

    // Show pages
    function showLoginPage() {
        loginPage.classList.remove('hidden');
        mainPortal.classList.add('hidden');
        adminPortal.classList.add('hidden');
    }

    function showMainPortal() {
        loginPage.classList.add('hidden');
        mainPortal.classList.remove('hidden');
        adminPortal.classList.add('hidden');
        initializeChat();
    }

    function showAdminPortal() {
        loginPage.classList.add('hidden');
        mainPortal.classList.add('hidden');
        adminPortal.classList.remove('hidden');
        loadAdminData();
    }

    // Existing chat and admin functionality remains the same...

    // Session Check on Page Load
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            showLoading(true);
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                const { data: userData } = await supabase
                    .from('users')
                    .select('role')
                    .eq('email', session.user.email)
                    .single();

                if (userData.role === 'admin') {
                    showAdminPortal();
                } else {
                    showMainPortal();
                }
            } else {
                showLoginPage();
            }
        } catch (error) {
            console.error('Session check error:', error);
            showLoginPage();
        } finally {
            showLoading(false);
        }
    });
</script>
