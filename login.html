<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
    // Configura√ß√£o do Supabase
    const SUPABASE_URL = 'https://lmlxvmzeifjvjakpomgp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxtbHh2bXplaWZqdmpha3BvbWdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMwMTQ0MzgsImV4cCI6MjA1ODU5MDQzOH0.QmHSbZrzRhos0DqQFZDnbeqvV9dcRYISQ88MbNsRDyM';

    // Elemento para carregar a biblioteca
    function loadScript(src) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = src;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }

    // Fun√ß√£o principal de inicializa√ß√£o
    async function initializeAuthentication() {
        try {
            // Garantir que o Supabase esteja carregado
            if (typeof supabase === 'undefined') {
                await loadScript('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js');
            }

            // Inicializar Supabase
            const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // Elementos do DOM
            const loginForm = document.getElementById('loginForm');
            const messageArea = document.getElementById('messageArea');
            const senhaInput = document.getElementById('senha');
            const passwordToggle = document.getElementById('passwordToggle');

            // Configurar toggle de visibilidade da senha
            passwordToggle.addEventListener('click', () => {
                const type = senhaInput.type === 'password' ? 'text' : 'password';
                senhaInput.type = type;
                passwordToggle.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è';
            });

            // Fun√ß√£o para mostrar mensagens de erro
            function showErrorMessage(message) {
                messageArea.textContent = message;
                messageArea.className = 'message message-error';
            }

            // Fun√ß√£o para mostrar mensagens de sucesso
            function showSuccessMessage(message) {
                messageArea.textContent = message;
                messageArea.className = 'message message-success';
            }

            // Verificar sess√£o inicial
            const { data: { session } } = await supabaseClient.auth.getSession();

            if (session) {
                // Se j√° estiver logado, verificar o papel do usu√°rio
                const { data: userData } = await supabaseClient
                    .from('users')
                    .select('role')
                    .eq('email', session.user.email)
                    .single();

                // Redirecionar baseado no papel
                if (userData?.role === 'admin') {
                    window.location.href = 'admin.html';
                } else if (userData?.role === 'user') {
                    window.location.href = 'funcionario.html';
                }
                return;
            }

            // Configurar evento de login
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('email').value.trim();
                const senha = senhaInput.value;

                // Valida√ß√£o b√°sica
                if (!email || !senha) {
                    showErrorMessage('Por favor, preencha todos os campos');
                    return;
                }

                try {
                    // Tentar login
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email: email,
                        password: senha
                    });

                    if (error) {
                        showErrorMessage(error.message || 'Erro no login');
                        return;
                    }

                    if (data.user) {
                        // Verificar papel do usu√°rio
                        const { data: userData } = await supabaseClient
                            .from('users')
                            .select('role')
                            .eq('email', email)
                            .single();

                        // Redirecionar baseado no papel
                        if (userData?.role === 'admin') {
                            window.location.href = 'admin.html';
                        } else {
                            window.location.href = 'funcionario.html';
                        }
                    }
                } catch (err) {
                    showErrorMessage('Erro ao tentar login');
                    console.error('Erro de login:', err);
                }
            });

        } catch (error) {
            console.error('Erro de inicializa√ß√£o:', error);
            const messageArea = document.getElementById('messageArea');
            messageArea.textContent = 'Erro ao carregar a p√°gina de login. Recarregue ou tente novamente.';
            messageArea.className = 'message message-error';
        }
    }

    // Chamar inicializa√ß√£o quando o DOM estiver completamente carregado
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeAuthentication);
    } else {
        initializeAuthentication();
    }
</script>
